<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Ainulindale: La gran Canción</title>
  <script src="./js/phaser.js"></script>
  <script src="./js/movimientos.js"></script>
  <style type="text/css">
  body {
    margin: 0;
  }
  </style>
</head>
<body>

  <script type="text/javascript">

  var config = {
    type: Phaser.AUTO,
    width: 800,
    height: 600,
    backgroundColor:'2D2D2D',
    physics: {
      default: 'arcade',
      arcade: {
        //gravity: { y: 300 },
        debug: false
      }
    },
    scene: {
      preload: preload,
      create: create,
      update: update,
      render: render
    }
  };

  var player;
  var stars;
  var platforms;
  var cursors;
  var gameOver = false;
  var radius = 90;
  var game = new Phaser.Game(config);
  var angle = 0;
  var originX=400;
  var originY=450;
  var barras=[];
  var paso=0;
  var tween;
  var fromColors;
  var toColors;
  var tweenBarra1;
  var tweenBarraS;
  var tweenBarraS1;
  var tweenBarra2;
  var tweenBarraS2;
  var tweenBarraS3;

  function preload ()
  {
    this.load.image('ground', 'assets/platformBlanca.png');
    this.load.image('block', 'assets/grisSimple.png');
    this.load.image('star', 'assets/nota.png');
    this.load.image('bomb', 'assets/bomb.png');
    this.load.spritesheet('dude', 'assets/playerAmarillo.png', { frameWidth: 51, frameHeight: 48 });
    this.load.image('exp1', 'assets/playerAmarilloExplode1.png');
    this.load.image('exp2', 'assets/playerAmarilloExplode2.png');
    this.load.image('exp3', 'assets/playerAmarilloExplode3.png');
    this.load.image('exp4', 'assets/playerAmarilloExplode4.png');

    //Animacion de carga

    var progressBar = this.add.graphics();
            var progressBox = this.add.graphics();
            progressBox.fillStyle(0x222222, 0.8);
            progressBox.fillRect(240, 270, 320, 50);

            var width = this.cameras.main.width;
            var height = this.cameras.main.height;
            var loadingText = this.make.text({
                x: width / 2,
                y: height / 2 - 50,
                text: 'Cargando...',
                style: {
                    font: '20px monospace',
                    fill: '#ffffff'
                }
            });
            loadingText.setOrigin(0.5, 0.5);

            var percentText = this.make.text({
                x: width / 2,
                y: height / 2 - 5,
                text: '0%',
                style: {
                    font: '18px monospace',
                    fill: '#ffffff'
                }
            });
            percentText.setOrigin(0.5, 0.5);

            var assetText = this.make.text({
                x: width / 2,
                y: height / 2 + 50,
                text: '',
                style: {
                    font: '18px monospace',
                    fill: '#ffffff'
                }
            });

            assetText.setOrigin(0.5, 0.5);

            this.load.on('progress', function (value) {
                percentText.setText(parseInt(value * 100) + '%');
                progressBar.clear();
                progressBar.fillStyle(0xffffff, 1);
                progressBar.fillRect(250, 280, 300 * value, 30);
            });

            this.load.on('fileprogress', function (file) {
                assetText.setText('Creando los ' + file.key);
            });

            this.load.on('complete', function () {
                progressBar.destroy();
                progressBox.destroy();
                loadingText.destroy();
                percentText.destroy();
                assetText.destroy();
            });

            // this.load.image('logo', 'zenvalogo.png');
            // for (var i = 0; i < 5000; i++) {
            //     this.load.image('logo'+i, 'zenvalogo.png');
            // }
  }

  function create ()
  {

    //Empieza codigo de fondo
    //definir cantidad de figuras para el fondo
    var blocks = this.add.group({ key: 'block', repeat: 107, setScale: { x: 0, y: 0 } });
    Phaser.Actions.GridAlign(blocks.getChildren(), {
      width: 14,
      cellWidth: 80,
      cellHeight: 75,
      x: 60,
      y: 50
    });

    var _this = this;

    var i = 0;

    //define el bucle y movimiento del fondo del fondo
    blocks.children.iterate(function (child) {

      _this.tweens.add({
        targets: child,
        scaleX: 0.55,
        scaleY: 0.55,
        angle: 225,
        // opacity: 4,
        _ease: 'Sine.easeInOut',
        ease: 'Power2',
        duration: 1000,
        delay: i * 5,
        repeat: -1,
        yoyo: true,
        hold: 1000,
        repeatDelay: 750
      });

      i++;

      if (i % 110 === 0)
      {
        i = 0;
      }

    });


    //termina Codigo de fondo


    player = this.physics.add.sprite(100, 450, 'dude');
    sombra = this.physics.add.sprite(100, 450, 'dude');
    notaVaga = this.physics.add.sprite(400,300,'star');

    // Creacion de las Barras
    //barras = this.physics.add.staticGroup();
    //barras.create(600, 0, 'ground');

    //movimientoBarras(this.scope);

    //Creacion de las barras para el nivel
    barras = this.physics.add.image(600, -9, 'ground'); // Se agrega las barras 600,0 cordenada actual)
    marker = this.physics.add.image(600, -9, 'ground').setAlpha(0.7);//se crea una sombra (600,0 cordenada actual)
    marker1 = this.physics.add.image(600, -9, 'ground').setAlpha(0.3);//se crea una sombra (600,0 cordenada actual)

    //barras.body.setGravityY(-100);
    //movimiento de la barra (x,y cordenadas futuras)
    tweenBarra1=this.tweens.add({
      targets: barras,
      x: 600,
      y:730,
      duration: 3000,
      ease: 'Power2',
      repeat: 2 ,
        yoyo: false,
        repeatDelay: 200,
     completeDelay: 300
    });

    //movimiento de la sombra (x,y cordenadas futuras)
    tweenBarraS1=this.tweens.add({
      targets: marker,
      x: 600,
      y:730,
      duration: 3050,
      ease: 'Power2',
       repeat: 2,
        yoyo: false,
        repeatDelay: 150,
      completeDelay: 305
    });

    //movimiento de la sombra (x,y cordenadas futuras)
    this.tweens.add({
        targets: marker1,
        x: 600,
        y:730 ,
        //angle:180,
        repeat: 2,
        duration: 3100,
        repeatDelay: 100,
        ease: 'Power2',
       completeDelay: 305
    });


    barras2 = this.physics.add.image(200, -1200, 'ground'); // Se agrega las barras 600,0 cordenada actual)
    marker2 = this.physics.add.image(200, -1200, 'ground').setAlpha(0.7);//se crea una sombra (600,0 cordenada actual)
    marker3 = this.physics.add.image(200, -1200, 'ground').setAlpha(0.3);//se crea una sombra (600,0 cordenada actual)

    barras2.scaleX=Phaser.Math.FloatBetween(0.5, 0.8)
    marker2.scaleX=barras2.scaleX
    marker3.scaleX=barras2.scaleX
    //barras.body.setGravityY(-100);
    //movimiento de la barra (x,y cordenadas futuras)
    tweenBarra2= this.tweens.add({
      targets: barras2,
      x: 200,
      y:730,
      duration: 3700,
      ease: 'Power2',
      repeat: 2,
      yoyo: false,
      repeatDelay: 200,
      completeDelay: 3000
    });

    //movimiento de la sombra (x,y cordenadas futuras)
    tweenBarraS2= this.tweens.add({
      targets: marker2,
      x: 200,
      y:730,
      duration: 3750,
      ease: 'Power2',
      repeat: 2,
      yoyo: false,
      repeatDelay: 150,
      completeDelay: 3050
    });

    //movimiento de la sombra (x,y cordenadas futuras)
    tweenBarraS3= this.tweens.add({
        targets: marker3,
        x: 200,
        y:730 ,
        //angle:180,
        duration: 3800,
        repeatDelay: 100,
        ease: 'Power2',
        repeat: 2,
        completeDelay: 3050
    });

    //Dibujamos el circulo de accion del pj
    graphics = this.add.graphics({ lineStyle: { width: 2, color: 0xf8ffaa}});
    circle = new Phaser.Geom.Circle(originX, originY, radius);
    graphics.strokeCircleShape(circle);
    graphics.alpha = 0.3;

    //Dibujar Pentagrama
    var line = new Phaser.Geom.Line(400, 0, 400, 600);
    graphics.lineStyle(1, 0xFFFFFF);
    graphics.strokeLineShape(line);

    var line2 = new Phaser.Geom.Line(360, 0, 360, 600);
    graphics.lineStyle(1, 0xFFFFFF);
    graphics.strokeLineShape(line2);

    var line3 = new Phaser.Geom.Line(380, 0, 380, 600);
    graphics.lineStyle(1, 0xFFFFFF);
    graphics.strokeLineShape(line3);

    var line4 = new Phaser.Geom.Line(400, 0, 400, 600);
    graphics.lineStyle(1, 0xFFFFFF);
    graphics.strokeLineShape(line4);

    var line5 = new Phaser.Geom.Line(420, 0, 420, 600);
    graphics.lineStyle(1, 0xFFFFFF);
    graphics.strokeLineShape(line5);

    var line6 = new Phaser.Geom.Line(440, 0, 440, 600);
    graphics.lineStyle(1, 0xFFFFFF);
    graphics.strokeLineShape(line6);

    //Colisiones del PJ
    //player.setBounce(0.2);
    player.setCollideWorldBounds(true);

    //Añadimos la animación al PJ
    this.anims.create({
      key: 'left',
      frames: this.anims.generateFrameNumbers('dude', { start: 0, end: 4 }),
      frameRate: 15,
      repeat: -1
    });

    this.anims.create({
      key: 'turn',
      frames: [ { key: 'dude', frame: 4 } ],
      //frames: this.anims.generateFrameNumbers('dude', { start: 4, end: 6 }),
      frameRate: 10,
    });

    this.anims.create({
      key: 'right',
      frames: this.anims.generateFrameNumbers('dude', { start: 0, end: 4 }),
      frameRate: 15,
      repeat: -1
    });

    this.anims.create({
      key: 'up',
      frames: this.anims.generateFrameNumbers('dude', { start: 0, end: 4 }),
      frameRate: 15,
      repeat: -1
    });

    this.anims.create({
      key: 'down',
      frames: this.anims.generateFrameNumbers('dude', { start: 0, end: 4 }),
      frameRate: 15,
      repeat: -1
    });
    //Creamos la animación de la explosión del jugador
    this.anims.create({
      key: 'explode',
      frames: [
        { key: 'exp1' },
        { key: 'exp2' },
        { key: 'exp3' },
        { key: 'exp4' }
      ],
      frameRate: 8,
      repeat: -1
    });


    cursors = this.input.keyboard.createCursorKeys();
    stars = this.physics.add.group({
      key: 'star',
      repeat: 3,
      setXY: { x: 300, y: 0, stepX: 50, stepY: -55 }
    });
    notasVagas = this.physics.add.group({
      key: 'star',
      repeat: 3,
      setXY: { x: 300, y: 0, stepX: 50, stepY: -55 }
    });

    var _this = this;

    var i = 0;
    stars.children.iterate(function (child) {
      child.setBounceY(Phaser.Math.FloatBetween(0.4, 0.8));


       _this.tweens.add({
        targets: child,
        scaleX: 2,
        scaleY: 2,
        angle: 225,
        y:700,
        // opacity: 4,
        _ease: 'Sine.easeInOut',
        ease: 'Power2',
        duration: 7000,
        delay: i * 5,
        repeat: -1,
        yoyo: false,
        hold: 1000,
        repeatDelay: 150
      });

      i++;

      if (i % 110 === 0)
      {
        i = 0;
      }

    });
    //Efecto de la nota vaga
     var _this = this;
     notasVagas.children.iterate(function (child) {
     child.setBounceY(Phaser.Math.FloatBetween(0.4, 0.8));
      _this.tweens.add({
         targets: child,
         scaleX: 2,
         scaleY: 2,
         angle: 200,
         //y:700,
         // opacity: 4,
         _ease: 'Sine.easeInOut',
         ease: 'Power2',
         duration: 4000,
         delay: i * 5,
         repeat: -1,
         yoyo: true,
         hold: 1000,
         repeatDelay: 150
       });

       i++;

       if (i % 110 === 0)
       {
         i = 0;
       }

     });


    //});

    //Colisiones de las barras
    this.physics.add.collider(stars, barras); // Colision
    //this.physics.add.collider(sombra, barras, hitBarra, null, this); // Para la interseccion  entre barra y player
	  this.physics.add.collider(stars, barras2); // Colision
    //this.physics.add.collider(sombra, barras2, hitBarra, null, this); // Para la interseccion  entre barra y player



    this.physics.add.overlap(sombra, stars, collectStar, null, this);
    this.physics.add.overlap(sombra, notaVaga, collectStar, null, this);
    player.x = (originX + Math.cos(Math.PI*0.03)*radius);
    player.y = (originY + Math.sin(Math.PI*0.03)*radius);
    player.body.allowGravity=false;
    sombra.setCollideWorldBounds(true);
    notaVaga.setCollideWorldBounds(true);

    //Colors
    fromColors = getRandomVertexColors();

    sombra.setTint(
        fromColors.topLeft.color,
        fromColors.topRight.color,
        fromColors.bottomLeft.color,
        fromColors.bottomRight.color
    );

    // Bind the scope to tintTween so we can use this.tweens inside it.
    tintTween = tintTween.bind(this);

    initTweens();

  }

  function update ()
  {
    var _this = this;
    notasVagas.children.iterate(function (child) {
      wander(child);
    });

    seek(sombra,player)
    wander(notaVaga);

    if (gameOver)
    {
      return;
    }


    this.input.mouse.disableContextMenu();

        // this.input.on('pointerdown', function (pointer) {
        //
        //   if (pointer.leftButtonDown())
        //     {
        //       angle -= Math.PI*0.0001
        //       player.x = (originX + Math.cos(angle)*radius);
        //       player.y = (originY + Math.sin(angle)*radius);
        //       sombra.anims.play('left', true);
        //     }
        //     else if (pointer.rightButtonDown())
        //     {
        //       angle += Math.PI*0.0001
        //       player.x =(originX + Math.cos(angle)*radius);
        //       player.y =(originY + Math.sin(angle)*radius);
        //       sombra.anims.play('right', true);
        //     }
        //
        // });

        // this.input.on('pointerup', function () {
        //
        //   player.setVelocityX(0);
        //
        //   sombra.anims.play('turn');
        //
        // });

        this.input.on('pointermove', function (pointer) {

          if (pointer.leftButtonDown())
            {
              angle -= Math.PI*0.0001
              player.x = (originX + Math.cos(angle)*radius);
              player.y = (originY + Math.sin(angle)*radius);
              sombra.anims.play('left', true);
            }
            else if (pointer.rightButtonDown())
            {
              angle += Math.PI*0.0001
              player.x =(originX + Math.cos(angle)*radius);
              player.y =(originY + Math.sin(angle)*radius);
              sombra.anims.play('right', true);
            }

        });

    if (cursors.left.isDown)
    {
      //X := originX + cos(angle)*radius;
      //Y := originY + sin(angle)*radius;
      angle -= Math.PI*0.03
      player.x = (originX + Math.cos(angle)*radius);
      player.y = (originY + Math.sin(angle)*radius);
      sombra.anims.play('left', true);

    }
    else if (cursors.right.isDown)
    {
      angle += Math.PI*0.03
      player.x =(originX + Math.cos(angle)*radius);
      player.y =(originY + Math.sin(angle)*radius);
      //player.setVelocityX(160);

      sombra.anims.play('right', true);

    }
    else
    {
      player.setVelocityX(0);

      sombra.anims.play('turn');
    }

    //magiabarra();



  }

  function collectStar (player, star)
  {
    star.disableBody(true, true);
  }


  function hitBarra (player, barras)
  {
    //Escondemos el circulo
    graphics.visible = false;

    this.physics.pause();
    tweenBarra1.stop();
    tweenBarraS.stop();
    tweenBarraS1.stop();
    tweenBarra2.stop();
    tweenBarraS2.stop();
    tweenBarraS3.stop();

    //sombra.setTint(0xff0f0f);

    sombra.anims.play('explode');

    gameOver = true;
  }

  function render () {

    //debug helper
    game.debug.spriteInfo(barra,32,32);

  }

  function getRandomVertexColors ()
{
    // Create a random color for each vertex.
    // RandomRGB returns a Phaser.Display.Color object with random RGB values.
    var RandomRGB = Phaser.Display.Color.RandomRGB;
    return {
        topLeft: RandomRGB(),
        topRight: RandomRGB(),
        bottomLeft: RandomRGB(),
        bottomRight: RandomRGB()
    };
}

function getTintColor (vertex)
{

    // Interpolate between the fromColor and toColor of the current vertex,
    // using the current tween value.
    var tint = Phaser.Display.Color.Interpolate.ColorWithColor(
        fromColors[vertex],
        toColors[vertex],
        100,
        tween.getValue()
    );

    // Interpolate.ColorWithColor returns a Javascript object with
    // interpolated RGB values. We convert it to a Phaser.Display.Color object
    // in order to get the integer value of the tint color.
    return Phaser.Display.Color.ObjectToColor(tint).color;
}

function tintTween (fromColors, toColors, callback)
{
    tween = this.tweens.addCounter({
        from: 0,
        to: 100,
        duration: 2000,
        onUpdate: function ()
        {
            sombra.setTint(
                getTintColor('topLeft'),
                getTintColor('topRight'),
                getTintColor('bottomLeft'),
                getTintColor('topRight')
            );
        },
        onComplete: callback
    });
}

function initTweens ()
{
    fromColors = toColors || fromColors;
    toColors = getRandomVertexColors();
    tintTween(
        fromColors,
        toColors,
        initTweens
    );
}

function magiabarra(){ // Es la misma barra una y otra vez.
  if (barras.y>700) {
    barras.y=0;
    barras.x = Phaser.Math.Between(0, 600);
    var escala=Phaser.Math.Between(1, 5);
    barras.setScale(1/escala,1);
    console.log(escala)
    console.log(barras.x)

}
}

function movimientoBarras(scope){
  //Creacion de las barras para el nivel
  scope.barras = this.physics.add.image(600, -9, 'ground'); // Se agrega las barras 600,0 cordenada actual)
  scope.marker = this.physics.add.image(600, -9, 'ground').setAlpha(0.7);//se crea una sombra (600,0 cordenada actual)
  scope.marker1 = this.physics.add.image(600, -9, 'ground').setAlpha(0.3);//se crea una sombra (600,0 cordenada actual)

  //barras.body.setGravityY(-100);
  //movimiento de la barra (x,y cordenadas futuras)
  scope.tweenBarra1=this.tweens.add({
    targets: barras,
    x: 600,
    y:730,
    duration: 3000,
    ease: 'Power2',
    repeat: 2 ,
      yoyo: false,
      repeatDelay: 200,
   completeDelay: 300
  });

  //movimiento de la sombra (x,y cordenadas futuras)
  scope.tweenBarraS1=this.tweens.add({
    targets: marker,
    x: 600,
    y:730,
    duration: 3050,
    ease: 'Power2',
     repeat: 2,
      yoyo: false,
      repeatDelay: 150,
    completeDelay: 305
  });

  //movimiento de la sombra (x,y cordenadas futuras)
  scope.tweens.add({
      targets: marker1,
      x: 600,
      y:730 ,
      //angle:180,
      repeat: 2,
      duration: 3100,
      repeatDelay: 100,
      ease: 'Power2',
     completeDelay: 305
  });


  scope.barras2 = scope.physics.add.image(200, -1200, 'ground'); // Se agrega las barras 600,0 cordenada actual)
  scope.marker2 = scope.physics.add.image(200, -1200, 'ground').setAlpha(0.7);//se crea una sombra (600,0 cordenada actual)
  scope.marker3 = scope.physics.add.image(200, -1200, 'ground').setAlpha(0.3);//se crea una sombra (600,0 cordenada actual)

  scope.barras2.scaleX=Phaser.Math.FloatBetween(0.5, 0.8)
  scope.marker2.scaleX=barras2.scaleX
  scope.marker3.scaleX=barras2.scaleX
  //barras.body.setGravityY(-100);
  //movimiento de la barra (x,y cordenadas futuras)
  scope.tweenBarra2= this.tweens.add({
    targets: barras2,
    x: 200,
    y:730,
    duration: 3700,
    ease: 'Power2',
    repeat: 2,
    yoyo: false,
    repeatDelay: 200,
    completeDelay: 3000
  });

  //movimiento de la sombra (x,y cordenadas futuras)
  scope.tweenBarraS2= this.tweens.add({
    targets: marker2,
    x: 200,
    y:730,
    duration: 3750,
    ease: 'Power2',
    repeat: 2,
    yoyo: false,
    repeatDelay: 150,
    completeDelay: 3050
  });

  //movimiento de la sombra (x,y cordenadas futuras)
  scope.tweenBarraS3= this.tweens.add({
      targets: marker3,
      x: 200,
      y:730 ,
      //angle:180,
      duration: 3800,
      repeatDelay: 100,
      ease: 'Power2',
      repeat: 2,
      completeDelay: 3050
  });
}


</script>

</body>
</html>
