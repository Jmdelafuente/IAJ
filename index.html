<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Ainulindale: La gran Canción</title>
  <script src="./js/phaser.js"></script>
  <style type="text/css">
  body {
    margin: 0;
  }
  </style>
</head>
<body>

  <script type="text/javascript">

  var config = {
    type: Phaser.AUTO,
    width: 800,
    height: 600,
    backgroundColor:'2D2D2D',
    physics: {
      default: 'arcade',
      arcade: {
        //gravity: { y: 300 },
        debug: false
      }
    },
    scene: {
      preload: preload,
      create: create,
      update: update,
      render: render
    }
  };

  var player;
  var stars;
  var platforms;
  var cursors;
  var gameOver = false;
  var radius = 60;
  var game = new Phaser.Game(config);
  var angle = 0;
  var originX=400;
  var originY=500;
  var barras=[];
  var paso=0;
  var tween;
  var fromColors;
  var toColors;

  function preload ()
  {
    this.load.image('ground', 'assets/platformBlanca.png');
    this.load.image('block', 'assets/grisSimple.png');
    this.load.image('star', 'assets/nota.png');
    this.load.image('bomb', 'assets/bomb.png');
    this.load.spritesheet('dude', 'assets/playerAmarillo.png', { frameWidth: 51, frameHeight: 48 });
    this.load.image('exp1', 'assets/playerAmarilloExplode1.png');
    this.load.image('exp2', 'assets/playerAmarilloExplode2.png');
    this.load.image('exp3', 'assets/playerAmarilloExplode3.png');
    this.load.image('exp4', 'assets/playerAmarilloExplode4.png');
  }

  function create ()
  {

    //Empieza codigo de fondo
    //definir cantidad de figuras para el fondo
    var blocks = this.add.group({ key: 'block', repeat: 107, setScale: { x: 0, y: 0 } });
    Phaser.Actions.GridAlign(blocks.getChildren(), {
      width: 14,
      cellWidth: 80,
      cellHeight: 75,
      x: 60,
      y: 50
    });

    var _this = this;

    var i = 0;

    //define el bucle y movimiento del fondo del fondo
    blocks.children.iterate(function (child) {

      _this.tweens.add({
        targets: child,
        scaleX: 0.55,
        scaleY: 0.55,
        angle: 225,
        // opacity: 4,
        _ease: 'Sine.easeInOut',
        ease: 'Power2',
        duration: 1000,
        delay: i * 5,
        repeat: -1,
        yoyo: true,
        hold: 1000,
        repeatDelay: 750
      });

      i++;

      if (i % 110 === 0)
      {
        i = 0;
      }

    });


    //termina Codigo de fondo


    player = this.physics.add.sprite(100, 450, 'dude');

    // Creacion de las Barras
    //barras = this.physics.add.staticGroup();
    //barras.create(600, 0, 'ground');

    //Creacion de las barras para el nivel
    barras = this.physics.add.image(600, 0, 'ground'); // Se agrega las barras 600,0 cordenada actual)
    marker = this.physics.add.image(600, 0, 'ground').setAlpha(0.3);//se crea una sombra (600,0 cordenada actual)
    //barras.body.setGravityY(-100);
    //movimiento de la barra (x,y cordenadas futuras)
    this.tweens.add({
      targets: barras,
      x: 600,
      y:617,
      duration: 3000,
      ease: 'Power2',        
      repeat: 5,
        yoyo: false,
        repeatDelay: 150,
      completeDelay: 3000
    });

    //movimiento de la sombra (x,y cordenadas futuras)
    this.tweens.add({
      targets: marker,
      x: 600,
      y:617,
      duration: 3200,
      ease: 'Power2',
       repeat: 5,
        yoyo: false,
        repeatDelay: 150,
      completeDelay: 3000
    });

    barras2 = this.physics.add.image(200, -1200, 'ground'); // Se agrega las barras 600,0 cordenada actual)
    marker2 = this.physics.add.image(200, -1200, 'ground').setAlpha(0.3);//se crea una sombra (600,0 cordenada actual)
    barras2.scaleX=Phaser.Math.FloatBetween(0.6, 0.8)
    marker2.scaleX=barras2.scaleX
    //barras.body.setGravityY(-100);
    //movimiento de la barra (x,y cordenadas futuras)
    this.tweens.add({
      targets: barras2,
      x: 200,
      y:617,
      duration: 3700,
      ease: 'Power2',
      repeat: 2,
      yoyo: false,
      repeatDelay: 150,
      completeDelay: 3000
    });

    //movimiento de la sombra (x,y cordenadas futuras)
    this.tweens.add({
      targets: marker2,
      x: 200,
      y:617,
      duration: 3900,
      ease: 'Power2',
      repeat: 2,
      yoyo: false,
      repeatDelay: 150,
      completeDelay: 3000
    });

    //Dibujamos el circulo de accion del pj
    graphics = this.add.graphics({ lineStyle: { width: 2, color: 0xf8ffaa}});
    circle = new Phaser.Geom.Circle(originX, originY, radius);
    graphics.strokeCircleShape(circle);
    graphics.alpha = 0.3;

    //Dibujar Pentagrama
    /*var line = new Phaser.Geom.Line(400, 0, 400, 600);
    graphics.lineStyle(1, 0xFFFFFF);
    graphics.strokeLineShape(line);

    var line2 = new Phaser.Geom.Line(360, 0, 360, 600);
    graphics.lineStyle(1, 0xFFFFFF);
    graphics.strokeLineShape(line2);
    
    var line3 = new Phaser.Geom.Line(380, 0, 360, 600);
    graphics.lineStyle(1, 0xFFFFFF);
    graphics.strokeLineShape(line3);
    
    var line4 = new Phaser.Geom.Line(400, 0, 360, 600);
    graphics.lineStyle(1, 0xFFFFFF);
    graphics.strokeLineShape(line4);
	*/

    //Colisiones del PJ
    player.setBounce(0.2);
    player.setCollideWorldBounds(true);

    //Añadimos la animación al PJ
    this.anims.create({
      key: 'left',
      frames: this.anims.generateFrameNumbers('dude', { start: 0, end: 4 }),
      frameRate: 15,
      repeat: -1
    });

    this.anims.create({
      key: 'turn',
      frames: [ { key: 'dude', frame: 4 } ],
      //frames: this.anims.generateFrameNumbers('dude', { start: 4, end: 6 }),
      frameRate: 10,
    });

    this.anims.create({
      key: 'right',
      frames: this.anims.generateFrameNumbers('dude', { start: 0, end: 4 }),
      frameRate: 15,
      repeat: -1
    });

    this.anims.create({
      key: 'up',
      frames: this.anims.generateFrameNumbers('dude', { start: 0, end: 4 }),
      frameRate: 15,
      repeat: -1
    });

    this.anims.create({
      key: 'down',
      frames: this.anims.generateFrameNumbers('dude', { start: 0, end: 4 }),
      frameRate: 15,
      repeat: -1
    });
    //Creamos la animación de la explosión del jugador
    this.anims.create({
      key: 'explode',
      frames: [
        { key: 'exp1' },
        { key: 'exp2' },
        { key: 'exp3' },
        { key: 'exp4' }
      ],
      frameRate: 8,
      repeat: -1
    });


    cursors = this.input.keyboard.createCursorKeys();
    stars = this.physics.add.group({
      key: 'star',
      repeat: 3,
      setXY: { x: 300, y: 0, stepX: 50, stepY: -55 }
    });



    var _this = this;

    var i = 0;
    stars.children.iterate(function (child) {
      child.setBounceY(Phaser.Math.FloatBetween(0.4, 0.8));
      
      
       _this.tweens.add({
        targets: child,
        angle: 225,
        y:700,
        // opacity: 4,
        _ease: 'Sine.easeInOut',
        ease: 'Power2',
        duration: 7000,
        delay: i * 5,
        repeat: -1,
        yoyo: false,
        hold: 1000,
        repeatDelay: 150
      });

      i++;

      if (i % 110 === 0)
      {
        i = 0;
      }

    });
    //});

    //Colisiones de las barras
    this.physics.add.collider(stars, barras); // Colision
    this.physics.add.collider(player, barras, hitBarra, null, this); // Para la interseccion  entre barra y player
	this.physics.add.collider(stars, barras2); // Colision
    this.physics.add.collider(player, barras2, hitBarra, null, this); // Para la interseccion  entre barra y player



    this.physics.add.overlap(player, stars, collectStar, null, this);
    player.x = (originX + Math.cos(Math.PI*0.03)*radius);
    player.y = (originY + Math.sin(Math.PI*0.03)*radius);
    player.body.allowGravity=false;
    //playerShadow = this.physics.add.image(player.x, player.y, 'exp1').setAlpha(0.8);//se crea una sombra (600,0 cordenada actual)

    //Colors
    fromColors = getRandomVertexColors();

    player.setTint(
        fromColors.topLeft.color,
        fromColors.topRight.color,
        fromColors.bottomLeft.color,
        fromColors.bottomRight.color
    );

    // Bind the scope to tintTween so we can use this.tweens inside it.
    tintTween = tintTween.bind(this);

    initTweens();

  }

  function update ()
  {
    if (gameOver)
    {
      return;
    }
    // this.tweens.add({
    //   targets: playerShadow,
    //   x: player.x,
    //   y:player.y+5,
    //   scaleX:0.8,
    //   scaleY:0.8,
    //   duration: 0.5,
    //   ease: 'Power4',
    //   completeDelay: 2
    // });

    if (cursors.left.isDown)
    {
      //X := originX + cos(angle)*radius;
      //Y := originY + sin(angle)*radius;
      angle -= Math.PI*0.03
      player.x = (originX + Math.cos(angle)*radius);
      player.y = (originY + Math.sin(angle)*radius);
      player.anims.play('left', true);

    }
    else if (cursors.right.isDown)
    {
      angle += Math.PI*0.03
      player.x =(originX + Math.cos(angle)*radius);
      player.y =(originY + Math.sin(angle)*radius);
      //player.setVelocityX(160);

      player.anims.play('right', true);

    }
    else
    {
      player.setVelocityX(0);

      player.anims.play('turn');
    }




  }

  function collectStar (player, star)
  {
    star.disableBody(true, true);
  }


  function hitBarra (player, barras)
  {
    //Escondemos el circulo
    graphics.visible = false;

    this.physics.pause();
	
	
    player.setTint(0xff0f0f);

    player.anims.play('explode');

    gameOver = true;
  }

  function render () {

    //debug helper
    game.debug.spriteInfo(barra,32,32);

  }

  function getRandomVertexColors ()
{
    // Create a random color for each vertex.
    // RandomRGB returns a Phaser.Display.Color object with random RGB values.
    var RandomRGB = Phaser.Display.Color.RandomRGB;
    return {
        topLeft: RandomRGB(),
        topRight: RandomRGB(),
        bottomLeft: RandomRGB(),
        bottomRight: RandomRGB()
    };
}

function getTintColor (vertex)
{

    // Interpolate between the fromColor and toColor of the current vertex,
    // using the current tween value.
    var tint = Phaser.Display.Color.Interpolate.ColorWithColor(
        fromColors[vertex],
        toColors[vertex],
        100,
        tween.getValue()
    );

    // Interpolate.ColorWithColor returns a Javascript object with
    // interpolated RGB values. We convert it to a Phaser.Display.Color object
    // in order to get the integer value of the tint color.
    return Phaser.Display.Color.ObjectToColor(tint).color;
}

function tintTween (fromColors, toColors, callback)
{
    tween = this.tweens.addCounter({
        from: 0,
        to: 100,
        duration: 2000,
        onUpdate: function ()
        {
            player.setTint(
                getTintColor('topLeft'),
                getTintColor('topRight'),
                getTintColor('bottomLeft'),
                getTintColor('topRight')
            );
        },
        onComplete: callback
    });
}

function initTweens ()
{
    fromColors = toColors || fromColors;
    toColors = getRandomVertexColors();
    tintTween(
        fromColors,
        toColors,
        initTweens
    );
}



</script>

</body>
</html>
